# Summary

Cross Site Script Inclusion (XSSI) vulnerability allows sensitive data leakage across-origin or cross-domain boundaries. Sensitive data could include authentication related data (login states, cookies, auth tokens, session IDs, etc.), user personal or sensitive personal data (email addresses, phone numbers, credit card details, social security numbers, etc.). XSSI is a client-side attack similar to Cross Site Request Forgery (CSRF) but they have a different purpose: CSRF uses the authenticated user context to execute certain state-changing actions inside a victimâ€™s page (eg. transfer money to the attacker's account, modify privileges, reset password, etc.) and an XSSI attack uses JavaScript on the client side to leak sensitive data from authenticated sessions.

By default websites are only allowed to access data if they are from the same origin. This is a key application security principle and governed by the same-origin policy (defined by RFC 6454 [1]). An origin is defined as the combination of URI scheme (http/https), host name, and port number. However, this policy is bypassed/not appliable for <SCRIPT> HTML tag inclusions. This exception is necessary, without it websites would not be able to consume third party services, traffic analysis or advertisement platforms, etc.

When the browser opens a website the <SCRIPT> resources are fetched from the cross-origin domain and they run in the same context as the including site/browser which presents the opportunity to leak sensitive data. This is in most cases JavaScript however the SCRIPT SRC entity doesn't have to be a JavaScript file or be served with text/javascript or .js extension. Some browsers are lenient and only block if it is served with an image type (image/), a video type (video/), an audio (audio/*) type, or text/csv [10].

Old browser version vulnerabilities (IE9/10) allowed data leakage via JavaScript error messages at runtime but those vulnerabilties have now been patched by vendors and are considered not as relevant. By setting the charset attribute of the <SCRIPT> tag the attacker/tester can enforce UTF-16 encoding which allows data leakage for other data formats (eg JSON). If you want to learn more about these please read Takeshi Terada: Identifier based XSSI attacks MBSD Technical Whitepaper [8].

The following XSSI vulnerability cases will be discussed:

1. Leak sensitive data via global variables
2. Leak sensitive data via global function parameters
3. Leak sensitive data via non-JavaScript resource - CSV with quotations theft
4. Leak sensitive data via JavaScript runtime errors

## Example - Leak sensitive data via global variables

1. An API key is stored in a JavaScript file with the URI https://victim.com/internal/api.js on the victim's website (victim.com) which is only accessible for authenticated users. The attacker/tester configures a website (attackingwebsite.com) and uses the <script> tag to refer to this JavaScript file in question.

api.js contents:
```
(function() {
  window.secret = "supersecretUserAPIkey";
})();
```

2. The attacker/tester has configured a website (attackingwebsite.com) with the following content:

index.html contents:
```
<!DOCTYPE html>
<html>
  <head>
    <title>Leaking data via global variables</title>
  </head>
  <body>
    <h1>Leaking data via global variables</h1>
    <script src="https://victim.com/internal/api.js"></script>
    <div id="result">
    </div>
    <script>
      var div = document.getElementById("result");
      div.innerHTML = "Your secret data <b>" + window.secret + "</b>"; 
    </script>
  </body>
</html>
```

3. The attacker lures the user to attackingwebsite.com either via social engineering, phishing emails, etc. This step requires the user to authenticate first to victim.com before visiting attackingwebsite.com.

4. The user's browser fetches the api.js and the sensitive data is leaked via the global JavaScript variable. 

## Example - Leak sensitive data via global function parameters

This example is similar to the previous one except in this case attackingwebsite.com uses a global JavaScript function to extract the sensitive data by overwriting the victim's global JavaScript function.

index.html contents:
```
<!DOCTYPE html>
<html>
  <head>
    <title>Leaking data via global function parameters 1</title>
  </head>
  <body>
    <div id="result">
    </div>
    <script>
      function globalFunction(param) {
        var div = document.getElementById("result");
        div.innerHTML = "Your secret data: <b>" + param + "</b>";
      }
    </script>
    <script src="https://victim.com/internal/api.js"></script>
  </body>
</html>
```

api.js contents:
```
(function() {
  var secret = "supersecretAPIkey";
  window.globalFunction(secret);
})();
```

There are other XSSI vulnerabilities leaking sensitive data either via JavaScript prototype chains or global function calls. If you want to learn more about these please visit Sebastian Leike's page [4].

## Example - Leak sensitive data via JavaScript runtime errors
## How to Test
### Black Box Testing
### Gray Box Testing
# Remediation
# References
# Tools
